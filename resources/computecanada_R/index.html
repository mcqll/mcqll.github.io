<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">

  <title>MCQLL
     | Compute Canada tutorial
  </title>
  <meta name="description" content="Montréal Computational & Quantitative Linguistics Lab
">

  <link rel="shortcut icon" href="/assets/img/favicon.ico">

  <link rel="stylesheet" href="/assets/css/main.css">
  <link rel="canonical" href="/resources/computecanada_R/">
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    
    <span class="site-title">
        <a class="page-link" href="/">
          <strong><div class="logodiv">
              <img class="logoimg" src="/assets/img/mcqll-logo-transparent.png">
          </div></strong>
        </a>
    </span>
    

    <nav class="site-nav">
      <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
              <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
              <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

      <div class="trigger">

        <!-- Blog -->
        <!-- <a class="page-link" href="/blog/">blog</a> -->

        <!-- Pages -->
        
          
            <a class="page-link" href="/about/">About</a>
          
        
          
        
          
            <a class="page-link" href="/join">Join</a>
          
        
          
        
          
            <a class="page-link" href="/meetings/">Meetings</a>
          
        
          
            <a class="page-link" href="/people">People</a>
          
        
          
            <a class="page-link" href="/publications">Publications</a>
          
        
          
            <a class="page-link" href="/resources">Resources</a>
          
        

      </div>
    </nav>

  </div>

</header>



    <div class="page-content">
      <div class="wrapper">
        <div class="post">

  <header class="post-header">
    <h1 class="post-title">
      
        <a href="/resources" class='post-pretitle'>Resources/</a>
      
      Compute Canada tutorial
    </h1>
    
    <h4 class="post-description">
      Steps to get set up to fit R models on a cluster
    </h4>
    
    <p class="post-meta">November 26, 2021 • Jacob and Connie</p>
  </header>

  <article class="post-content">
    <p><em>Note: As of April 1 Jan 2022, <strong>Compute Canada</strong> became <strong>Digital Research Alliance of Canada</strong>.</em></p>

<p>This is a short tutorial to test using Compute Canada (aka Digital Research Alliance of Canada) for R computing with <code class="language-plaintext highlighter-rouge">brms</code> and <code class="language-plaintext highlighter-rouge">mgcv</code>. See also <a href="https://medium.com/the-nature-of-food/how-to-run-your-r-script-with-compute-canada-c325c0ab2973">this blog post</a>. For complete information see the extensive <a href="https://docs.alliancecan.ca/wiki/Technical_documentation">technical documentation</a> on the official wiki.</p>

<h2 id="1-log-in-and-install-modules">1. Log in and install modules</h2>

<ol>
  <li>
    <p>Make sure you have an active account with <a href="https://ccdb.computecanada.ca/">CCDB</a>.</p>
  </li>
  <li>SSH in to a Compute Canada login node (with <code class="language-plaintext highlighter-rouge">-Y</code> for trusted X11 forwarding):
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  ssh <span class="nt">-Y</span> <span class="k">${</span><span class="nv">username</span><span class="k">}</span>@beluga.computecanada.ca
</code></pre></div>    </div>
    <p>where <code class="language-plaintext highlighter-rouge">${username}</code> is your Compute Canada username (not your CCI).  You could also replace <code class="language-plaintext highlighter-rouge">beluga</code> with another Compute Canada cluster name, if you’re not in Quebec (see <a href="https://alliancecan.ca/en/services/advanced-research-computing/accessing-resources/resource-allocation-competition/available-resources">here</a>).
  You will be prompted to enter a password. Note: if you have entered your public ssh key on the Alliance’s website, you won’t need a password (you can generate a key, or if you have a key on your computer already it’s probably at <code class="language-plaintext highlighter-rouge">~/.ssh/id_rs.pub</code>; you can paste the contents of that file on the Compute Canada website at <em>My Account &gt; Manage SSH Keys</em>, and press ‘Add Key’ and then you won’t need to use a password to login).</p>
  </li>
  <li>Once you’re logged into, you will see a welcome message and a bash prompt that looks something like <code class="language-plaintext highlighter-rouge">[username@beluga3 ~]$</code>.  You now need to load the necessary modules.  Use the following command.  Note: the bioconductor module is necessary for <code class="language-plaintext highlighter-rouge">brms</code> to work.
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>module load gcc/9.3.0 r-bundle-bioconductor/3.14 r/4.1.2
</code></pre></div>    </div>
    <p>You may get messages about modules being replaced/reloaded, which you can ignore.</p>
  </li>
  <li>Start an R session
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>R
</code></pre></div>    </div>
  </li>
  <li>Once R is started, install the R packages you want to use.
    <div class="language-R highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">install.packages</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="s2">"tidyverse"</span><span class="p">,</span><span class="w"> </span><span class="s2">"mgcv"</span><span class="p">,</span><span class="w"> </span><span class="s2">"brms"</span><span class="p">),</span><span class="w">
                 </span><span class="n">repos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"https://utstat.toronto.edu/cran/"</span><span class="p">)</span><span class="w">
</span></code></pre></div>    </div>
    <p>You may get a warning message saying <code class="language-plaintext highlighter-rouge">'lib = " ... "' is not writeable</code>, asking if I want to use a personal library (respond <code class="language-plaintext highlighter-rouge">y</code>), and then asking if you want to create the personal library directory to install packages into (respond <code class="language-plaintext highlighter-rouge">y</code> again).
  The packages will install (and take some time, like a half-hour).  If this succeeds, you should get a message like: <code class="language-plaintext highlighter-rouge">The downloaded source packages are in ‘/tmp/.../downloaded_packages’</code>, and no warnings.</p>
  </li>
  <li>Quit R with <code class="language-plaintext highlighter-rouge">q()</code>. You will return to the bash prompt on the login node.</li>
</ol>

<p>Now it should be all set.</p>

<p>Note: <em>Steps 1-4 you’ll use anytime you use the cluster for an R project. You should only have to run step 5 once ever (the packages will remain installed for you for all future sessions on Béluga).  If you need other packages in the future, just open R and <code class="language-plaintext highlighter-rouge">install.packages</code> as in step 5 to install them too.</em></p>

<h2 id="2-test-fitting-models-in-r">2. Test fitting models in R</h2>

<p>When you ssh into the cluster, you start out in a “login node” (you’ll see the name of the particular node your on at the prompt. It will probably have a name like <code class="language-plaintext highlighter-rouge">beluga3</code>).</p>

<p><strong>Important</strong>: <em>A login node is just your entry point to the cluster, it is not where you run your code. Fitting models on a login node will be slow (probably not faster your laptop), and more importantly, it can make the login node unusable to other users! Don’t be rude!</em>  To run things, you must do one of the following:</p>

<ul>
  <li>Run things interactively. This is for data exploration and interactive debugging of a script, for instance. See <strong>Section 2.1</strong> below.</li>
  <li>Use a job script to do batch submission. This is for large computational tasks, like fitting your heavy-duty models. In general, this is the default way Compute Canada expects you’ll use the cluster. See <strong>Section 2.2</strong> below.</li>
</ul>

<h3 id="21-running-things-interactively">2.1 Running things interactively</h3>
<p>(skip this section if you just want to submit jobs to be run)</p>

<ol>
  <li>
    <p>Start in a cluster login node, as above. Then, request an interactive session using the <code class="language-plaintext highlighter-rouge">salloc</code> command:</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>salloc <span class="nt">--x11</span> <span class="nt">--time</span><span class="o">=</span>1:0:0 <span class="nt">--ntasks</span><span class="o">=</span>4 <span class="nt">--mem-per-cpu</span><span class="o">=</span>4GB <span class="nt">--account</span><span class="o">=</span><span class="k">${</span><span class="nv">ACCOUNT</span><span class="k">}</span> 
</code></pre></div>    </div>
    <p>this example requests four CPU cores for one hour, with 4GB of RAM per CPU. <code class="language-plaintext highlighter-rouge">${ACCOUNT}</code> is the name of the account you want to use.</p>

    <ul>
      <li>
        <p>If you misspell or don’t specify the account, you’ll get a helpful error message telling you what accounts you are a member of. Choose one of them.</p>
      </li>
      <li>
        <p>The <code class="language-plaintext highlighter-rouge">--x11</code> flag is necessary only if you want to do interactive plotting.</p>
      </li>
    </ul>

    <p>After running the <code class="language-plaintext highlighter-rouge">salloc</code> command, you’ll see some messages like the below. It may take a minute, but once the resources you requested are allocated you, will see a bash prompt, like <code class="language-plaintext highlighter-rouge">[username@blg8610 ~]$</code></p>
  </li>
  <li>
    <p>Now you’re on a the “compute node”.  Start up <code class="language-plaintext highlighter-rouge">R</code>, where you can interactively run Test 1 and Test 2, below.</p>
  </li>
  <li>
    <p>After running the tests below, <code class="language-plaintext highlighter-rouge">q()</code> to quit R, and then <code class="language-plaintext highlighter-rouge">exit</code> to relinquish  the compute node (you’ll be returned to the login node).</p>
  </li>
</ol>

<h4 id="test-1-using-mgcv">Test 1: using <code class="language-plaintext highlighter-rouge">mgcv</code></h4>

<p>Let’s test fitting a GAM.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">library</span><span class="p">(</span><span class="n">mgcv</span><span class="p">)</span><span class="w">
</span><span class="n">dat</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">gamSim</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="n">n</span><span class="o">=</span><span class="m">400</span><span class="p">,</span><span class="n">dist</span><span class="o">=</span><span class="s2">"normal"</span><span class="p">,</span><span class="n">scale</span><span class="o">=</span><span class="m">2</span><span class="p">)</span><span class="w">
</span><span class="n">b</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">gam</span><span class="p">(</span><span class="n">y</span><span class="o">~</span><span class="n">s</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span><span class="o">+</span><span class="n">s</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span><span class="o">+</span><span class="n">s</span><span class="p">(</span><span class="n">x2</span><span class="p">)</span><span class="o">+</span><span class="n">s</span><span class="p">(</span><span class="n">x3</span><span class="p">),</span><span class="n">data</span><span class="o">=</span><span class="n">dat</span><span class="p">)</span><span class="w">
</span><span class="n">summary</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>
<p>This should fit the model and print the summary.</p>

<p>and (if you used <code class="language-plaintext highlighter-rouge">-x11</code> flag to <code class="language-plaintext highlighter-rouge">salloc</code> when you requested the allocation), test plotting the model, like so</p>

<div class="language-R highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">plot</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">select</span><span class="o">=</span><span class="m">1</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>This should use X11 forwarding to show a plot of the fit smooth for <code class="language-plaintext highlighter-rouge">s(x0)</code>.</p>

<h4 id="test-2-using-brms">Test 2: using <code class="language-plaintext highlighter-rouge">brms</code></h4>

<p>Let’s test fitting a Bayesian regression model with <code class="language-plaintext highlighter-rouge">brm()</code></p>

<div class="language-R highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">library</span><span class="p">(</span><span class="n">brms</span><span class="p">)</span><span class="w">
</span><span class="n">data</span><span class="p">(</span><span class="s2">"kidney"</span><span class="p">)</span><span class="w">
</span><span class="n">fit1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">brm</span><span class="p">(</span><span class="w">
  </span><span class="n">formula</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">cens</span><span class="p">(</span><span class="n">censored</span><span class="p">)</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">age</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sex</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">disease</span><span class="w">
  </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="m">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">age</span><span class="o">|</span><span class="n">patient</span><span class="p">),</span><span class="w">
  </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kidney</span><span class="p">,</span><span class="w"> </span><span class="n">family</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lognormal</span><span class="p">(),</span><span class="w">
  </span><span class="n">prior</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">set_prior</span><span class="p">(</span><span class="s2">"normal(0,5)"</span><span class="p">,</span><span class="w"> </span><span class="n">class</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"b"</span><span class="p">),</span><span class="w">
  </span><span class="n">set_prior</span><span class="p">(</span><span class="s2">"cauchy(0,2)"</span><span class="p">,</span><span class="w"> </span><span class="n">class</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"sd"</span><span class="p">),</span><span class="w">
  </span><span class="n">set_prior</span><span class="p">(</span><span class="s2">"lkj(2)"</span><span class="p">,</span><span class="w"> </span><span class="n">class</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"cor"</span><span class="p">)),</span><span class="w">
  </span><span class="n">warmup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1000</span><span class="p">,</span><span class="w"> </span><span class="n">iter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2000</span><span class="p">,</span><span class="w"> </span><span class="n">chains</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">4</span><span class="p">,</span><span class="w"> </span><span class="n">cores</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">4</span><span class="p">,</span><span class="w">
  </span><span class="n">control</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">list</span><span class="p">(</span><span class="n">adapt_delta</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.95</span><span class="p">))</span><span class="w">
</span><span class="n">summary</span><span class="p">(</span><span class="n">fit1</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>This should compile the Stan program and fit the model, and print a summary.  Works for me.  Also test plotting with <code class="language-plaintext highlighter-rouge">plot(fit1, select=1)</code>.  Note that setting <code class="language-plaintext highlighter-rouge">cores=4</code> tells the <code class="language-plaintext highlighter-rouge">brms</code> to make use of the multiple cores you requested.</p>

<p>When you’re done, you can quit R and exit the compute node (also, be aware that you’ll be kicked out automatically after the time you requested has been used up).</p>

<h3 id="22-running-things-in-a-job-script">2.2 Running things in a job script</h3>

<p>Start in a login node.</p>

<p>Let’s make an R script that does the same two tests above. Name the script <code class="language-plaintext highlighter-rouge">Rtest.R</code>, and save it in the user directory of the login node (that’ll be accessible from the compute nodes too), by running the following:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span><span class="p">;</span>
<span class="nb">cat</span> <span class="o">&gt;</span> Rtest.R <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh">
## testing mgcv
library(mgcv)
dat &lt;- gamSim(1,n=400,dist="normal",scale=2)
gam1 &lt;- gam(y~s(x0)+s(x1)+s(x2)+s(x3),data=dat)
summary(gam1)
png(file="Rtest-plots/gam1.png", width=600, height=500)
plot(gam1, select=1)
dev.off()

## testing brms
library(brms)
data("kidney")
fit1 &lt;- brm(
  formula = time | cens(censored) ~ age * sex + disease
  + (1 + age|patient),
  data = kidney, family = lognormal(),
  prior = c(set_prior("normal(0,5)", class = "b"),
  set_prior("cauchy(0,2)", class = "sd"),
  set_prior("lkj(2)", class = "cor")),
  warmup = 1000, iter = 2000, chains = 4, cores = 4,
  control = list(adapt_delta = 0.95))
summary(fit1)
png(file="Rtest-plots/fit1.png", width=600, height=500)
plot(fit1, select=1)
dev.off()
</span><span class="no">EOF
</span></code></pre></div></div>

<p>Now make a job script, and save it as <code class="language-plaintext highlighter-rouge">Rtest-job.sh</code> in the home directory too:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span><span class="p">;</span>
<span class="nb">cat</span> <span class="o">&gt;</span> Rtest-job.sh <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh">
#!/bin/bash
#SBATCH --account=</span><span class="k">${</span><span class="nv">ACCOUNT</span><span class="k">}</span><span class="sh">
#SBATCH --time=00:15:00
#SBATCH --mem-per-cpu=4G
#SBATCH --cpus-per-task=8
#SBATCH --job-name=Rtest
#SBATCH --output=%x-%j.out
#SBATCH --mail-user=</span><span class="k">${</span><span class="nv">EMAIL</span><span class="k">}</span><span class="sh">
#SBATCH --mail-type=ALL
module load gcc/9.3.0 r-bundle-bioconductor/3.14 r/4.1.2
Rscript Rtest.R
</span><span class="no">EOF
</span></code></pre></div></div>

<p>This requests 15 minutes of time on a compute node with 8 CPUs, and 4GB of RAM per each. <code class="language-plaintext highlighter-rouge">${ACCOUNT}</code> should be the account name you want to use. Set <code class="language-plaintext highlighter-rouge">${EMAIL}</code> to your email address to be alerted when the job starts/finishes/fails (optional). The <code class="language-plaintext highlighter-rouge">--output</code> flag specifies the format for the output file you’ll get when your job terminates.  In this case, we’re setting it to be <code class="language-plaintext highlighter-rouge">Rtest-jobnumber.out</code>.</p>

<p>Make a directory for the test plots to be put in:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">mkdir </span>Rtest-plots
</code></pre></div></div>

<p>Submit the job to be scheduled.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sbatch Rtest-job.sh
</code></pre></div></div>

<p>You’ll see something like <code class="language-plaintext highlighter-rouge">Submitted batch job 27701226</code>.
You can use <code class="language-plaintext highlighter-rouge">squeue</code> or <code class="language-plaintext highlighter-rouge">sq</code> to see the list of queued jobs.  Hopefully yours will be run soon.</p>

<p>When finished, the following outputs will be in the home directory</p>

<ul>
  <li>An out file with a name like <code class="language-plaintext highlighter-rouge">Rtest-27701226.out</code>, containing the stdout stuff from the R script (and if the job crashed, useful info may be in there).</li>
  <li>Two plots, in the <code class="language-plaintext highlighter-rouge">test-plots/</code> directory.</li>
</ul>

<h2 id="3-transferring-files">3. Transferring files</h2>

<p>Beyond just running a simple test like above, you’ll likely need to transfer datasets and scripts to the cluster before running things.</p>

<p>To  transfer files between your local machine and your home directory on Béluga</p>

<ul>
  <li>you can use <a href="https://linux.die.net/man/1/scp"><code class="language-plaintext highlighter-rouge">scp</code></a> or <a href="https://linux.die.net/man/1/rsync"><code class="language-plaintext highlighter-rouge">rsync</code></a> to copy files via SSH (or on Windows, equivalent tools). For example, to copy a script from your laptop to your home directory on Béluga, run something like the following (on your local terminal):
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>scp /path/to/myscript.R <span class="k">${</span><span class="nv">username</span><span class="k">}</span>@beluga.computecanada.ca:/home/<span class="k">${</span><span class="nv">username</span><span class="k">}</span>/
</code></pre></div>    </div>
    <p>You can use it similarly to copy output files back to your local machine.</p>
  </li>
  <li>for large/multiple files, the Alliance <a href="https://docs.alliancecan.ca/wiki/Transferring_data">recommends the <em>Globus</em> system</a>.</li>
</ul>


  </article>

  

</div>

      </div>
    </div>

    <!-- <footer>

  <div class="wrapper">
    &copy; 2025 MCQLL.
    
    
  </div>

</footer>
 -->

    <!-- Load jQuery -->
<script src="//code.jquery.com/jquery-1.12.4.min.js"></script>

<!-- Load Common JS -->
<script src="/assets/js/common.js"></script>

<!-- HACK, add latecx support with mathjax not sure why this isn't working, but this should do it -->
<script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script>





<!-- Include custom icon fonts -->
<link rel="stylesheet" href="/assets/css/fontawesome-all.min.css">
<link rel="stylesheet" href="/assets/css/academicons.min.css">

<!-- Google Analytics -->
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', '', 'auto');
ga('send', 'pageview');
</script>


  </body>

</html>
